---
import styles from './style.module.css';

type Props = {
  lightboxUrl: string;
};
---

<img-lightbox
  class={styles.lightbox}
  data-url={Astro.props.lightboxUrl}
  data-dialog-class={styles.dialog}
  data-wrapper-class={styles.imageWrapper}
  data-close-button-class={styles.closeButton}
  data-loading-class={styles.loading}
>
  <slot />
</img-lightbox>

<script>
  import { WebComponent } from '~/lib/WebComponent';

  let dialog: HTMLDialogElement | null = null;
  let currentImage: HTMLImageElement | null = null;

  class ImgLightbox extends WebComponent {
    parsedCallback() {
      this.tabIndex = 0;

      if (!this.dataset.url) return;

      const link = this.querySelector('a');
      if (link) {
        link.tabIndex = -1;
      }

      this.on(this, 'click', (e) => {
        e.preventDefault();
        this.openLightbox();
      });

      this.on(this, 'keydown', (e) => {
        if (e.altKey) return;
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          this.openLightbox();
        }
      });
    }

    getDialog() {
      if (!dialog) {
        dialog = document.createElement('dialog');
        dialog.className = this.dataset.dialogClass!;

        const container = document.createElement('div');
        container.style.position = 'relative';

        const closeButton = document.createElement('button');
        closeButton.className = this.dataset.closeButtonClass!;
        closeButton.innerHTML = '&times; Close';
        closeButton.addEventListener('click', () => dialog!.close());
        container.appendChild(closeButton);

        const wrapper = document.createElement('div');
        wrapper.className = this.dataset.wrapperClass!;

        currentImage = document.createElement('img');
        wrapper.appendChild(currentImage);

        container.appendChild(wrapper);
        dialog.appendChild(container);
        document.body.appendChild(dialog);

        dialog.addEventListener('click', (e) => {
          if (e.target === dialog) {
            dialog!.close();
          }
        });

        dialog.addEventListener('close', () => {
          document.body.style.overflow = '';
        });
      }
      return dialog;
    }

    openLightbox() {
      this.classList.add(this.dataset.loadingClass!);

      const preloader = new Image();
      preloader.onload = () => {
        this.classList.remove(this.dataset.loadingClass!);

        const d = this.getDialog();
        currentImage!.src = this.dataset.url!;
        document.body.style.overflow = 'hidden';
        d.showModal();
      };
      preloader.onerror = () => {
        this.classList.remove(this.dataset.loadingClass!);
      };
      preloader.src = this.dataset.url!;
    }
  }

  customElements.define('img-lightbox', ImgLightbox);
</script>
