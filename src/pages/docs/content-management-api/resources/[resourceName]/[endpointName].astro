---
import { ContentPlusToc } from '~/components/docs/ContentPlusToc';
import { DraftModeQueryListener } from '~/components/DraftModeQueryListener';
import { findGroup, GroupLayout } from '~/layouts/docs/GroupLayout';
import { notFoundResponse } from '~/lib/notFoundResponse';
import { buildSidebarItems, findResource } from '../../_buildSidebarItems';

const sidebarItems = await buildSidebarItems(Astro.params.resourceName);
const resource = await findResource(Astro.params.resourceName!);

const result = await findGroup(Astro, 'content-management-api');

if (!result || !resource) {
  return notFoundResponse();
}

const [group, queryListenerProps] = result;

const endpoint = resource.links!.find((endpoint) => endpoint.rel === Astro.params.endpointName);

if (!endpoint) {
  return notFoundResponse();
}
---

<GroupLayout group={group} additionalSeo={[]} additionalSidebarItems={sidebarItems}>
  <ContentPlusToc tocGroups={[]}>
    <Fragment slot="kicker">Content Management API > {resource.title}</Fragment>
    <Fragment slot="title">{endpoint.title}</Fragment>
  </ContentPlusToc>
</GroupLayout>

{queryListenerProps.map((props) => <DraftModeQueryListener {...props} />)}
