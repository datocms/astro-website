---
import { query } from './_graphql';
import { executeQuery } from '~/lib/datocms/executeQuery';
import { avoidAstroTypeCheckBug, notFoundResponse } from '~/lib/notFoundResponse';
import { Wrapper } from '~/components/Wrapper';
import { ensureValidStructuredTextProps } from '@datocms/astro';
import { Text } from '~/components/structuredText/Text';
import { Space } from '~/components/Space';
import { ResponsiveImage } from '~/components/ResponsiveImage';
import { LogosBar } from '~/components/LogosBar';
import { Layout } from '~/layouts/Layout';
import { Hero } from '~/components/Hero';
import { Svg } from '~/components/Svg';
import { buildUrlForSuccessStory } from '~/lib/datocms/gqlUrlBuilder/successStory';
import { DraftModeQueryListener } from '~/components/DraftModeQueryListener';
import { StripWithContent } from '~/components/StripWithContent';
import s from './_style.module.css';

const { page, posts } = await executeQuery(Astro, query);

if (!page || posts.length === 0) {
  avoidAstroTypeCheckBug(notFoundResponse);
  return notFoundResponse();
}
---

<Layout seo={page.seo}>
  <Hero>
    <Fragment slot="kicker">Success stories</Fragment>
    <Fragment slot="title">Powered by <mark>DatoCMS</mark></Fragment>
    <Fragment slot="subtitle">
      Learn how companies are building their next-generation digital products with structured,
      flexible content at their core
    </Fragment>
  </Hero>

  <Space top={1} bottom={1}>
    <LogosBar
      title=""
      clients={[
        'svg/logos/vercel',
        'svg/logos/deutsche-telekom',
        'svg/logos/harrys',
        'svg/logos/nhs',
        'svg/logos/verizon',
        'svg/logos/mit',
      ]}
    />
  </Space>

  <div class={s.posts}>
    {
      posts.map((post, i) => (
        <StripWithContent background={i % 2 === 0 ? 'normal' : 'alternative'}>
          <Wrapper>
            <a class={s.post} href={buildUrlForSuccessStory(post)}>
              <div class={s.postVisual}>
                <div class={s.postImage}>
                  <ResponsiveImage data={post.coverImage.responsiveImage} />
                </div>
                <div class={s.postLogos}>
                  <img src={post.logo.url} class={s.postLogo} />
                  <span class={s.plus}>+</span>
                  <Svg name="svg/logos/datocms" />
                </div>
              </div>
              <div class={s.postBody}>
                <div class={s.postTitle}>
                  <Text {...ensureValidStructuredTextProps({ data: post.title })} />
                </div>
                {post.numbers.length > 0 && (
                  <div class={s.postNumbers}>
                    {post.numbers.map((item) => (
                      <div class={s.numberBlock}>
                        <h3 class={s.numberTitle}>{item.number}</h3>
                        <p class={s.numberLabel}>{item.label}</p>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </a>
          </Wrapper>
        </StripWithContent>
      ))
    }
  </div>

  <DraftModeQueryListener query={query} />
</Layout>
