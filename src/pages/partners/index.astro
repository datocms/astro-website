---
import PartnersMap from './_sub/PartnersMap';
import s from './_style.module.css';
import sortBy from 'lodash-es/sortBy';
import { Announce } from '~/components/pluginToolkit/Announce';
import { Hero } from '~/components/Hero';
import { Layout } from '~/layouts/Layout';
import { Card } from '~/components/Card';
import { Space } from '~/components/Space';
import { Wrapper } from '~/components/Wrapper';
import { executeQuery } from '~/lib/datocms/executeQuery';
import { notFoundResponse, avoidAstroTypeCheckBug } from '~/lib/notFoundResponse';
import { query } from './_graphql';
import { render as toPlainText } from 'datocms-structured-text-to-plain-text';
import { buildUrlForPartner } from '~/lib/datocms/gqlUrlBuilder/partner';
import { DraftModeQueryListener } from '~/components/DraftModeQueryListener';
import { countersForDropdown, countersToOptions } from './_facets';
import { FetchAndReplaceFormOnSubmit } from '~/components/filtering/FetchAndReplaceFormOnSubmit';
import { Filter } from '~/components/filtering/Filter';
import { stripStega } from '@datocms/astro';

const { page, partners } = await executeQuery(Astro, query);

if (!page || partners.length === 0) {
  avoidAstroTypeCheckBug(notFoundResponse);
  return notFoundResponse();
}

const projectsCountByPartner = partners.reduce<Record<string, number>>((acc, partner) => {
  acc[partner.id] = partner._allReferencingShowcaseProjectsMeta.count;
  return acc;
}, {});

const highlightedPartnerIds = page.highlightedPartners.map((p) => p.id);

const orderedPartnersWithStega = [
  ...page.highlightedPartners,
  ...sortBy(
    partners.filter((p) => !highlightedPartnerIds.includes(p.id)),
    [(x) => -(projectsCountByPartner[x.id] || 0), 'name'],
  ),
];

const orderedPartnersWithoutStega = stripStega(orderedPartnersWithStega);

const partnersCountByCountryCode = partners
  .flatMap((partner) => partner.locations.map((location) => location.code))
  .reduce<Record<string, number>>((acc, code) => {
    acc[code] = (acc[code] || 0) + 1;
    return acc;
  }, {});

const technologyFilter = Astro.url.searchParams.get('technology');
const areaOfExpertiseFilter = Astro.url.searchParams.get('areaOfExpertise');
const countryFilter = Astro.url.searchParams.get('country');
const continentFilter = Astro.url.searchParams.get('continent');

const filteredPartners = orderedPartnersWithoutStega.filter((partner) => {
  if (technologyFilter && !partner.technologies.some((t) => t.name === technologyFilter)) {
    return false;
  }
  if (
    areaOfExpertiseFilter &&
    !partner.areasOfExpertise.some((t) => t.name === areaOfExpertiseFilter)
  ) {
    return false;
  }
  if (countryFilter && !partner.locations.some((t) => `${t.emoji} ${t.name}` === countryFilter)) {
    return false;
  }
  if (continentFilter && !partner.locations.some((t) => t.continent.name === continentFilter)) {
    return false;
  }

  return true;
});

// Faceted search: build dropdown options
const activeFilters = {
  technology: technologyFilter,
  areaOfExpertise: areaOfExpertiseFilter,
  country: countryFilter,
  continent: continentFilter,
};

const techCounters = countersForDropdown(orderedPartnersWithoutStega, activeFilters, 'technology');
const areaCounters = countersForDropdown(
  orderedPartnersWithoutStega,
  activeFilters,
  'areaOfExpertise',
);
const countryCounters = countersForDropdown(orderedPartnersWithoutStega, activeFilters, 'country');
const continentCounters = countersForDropdown(
  orderedPartnersWithoutStega,
  activeFilters,
  'continent',
);

const continentOptions = countersToOptions(continentCounters.continents);
const countryOptions = countersToOptions(countryCounters.countries);
const technologyOptions = countersToOptions(techCounters.technologies);
const areaOfExpertiseOptions = countersToOptions(areaCounters.areasOfExpertise);

const getLabel = (count: number) => {
  if (count === 0) {
    return false;
  }
  if (count === 1) {
    return '1 showcase project';
  }
  return `${count} showcase projects`;
};

const bkgColors = ['azure', 'pink', 'blue', 'green', 'yellow'] as const;
---

<Layout seo={[]}>
  <Fragment slot="head">
    <title>DatoCMS Solution Partners</title>
  </Fragment>

  <Hero>
    <Fragment slot="kicker">Solution Partners</Fragment>
    <Fragment slot="title">
      Find the perfect Partner to meet <mark>your digital needs</mark>
    </Fragment>
    <Fragment slot="subtitle">
      Our most successful customers work with a Solution Partner to accomplish their goals and ship
      their digital products faster.
    </Fragment>
  </Hero>

  <Wrapper>
    <PartnersMap partnersCountByCountryCode={partnersCountByCountryCode} client:load />
    <Space bottom={1}>
      <Announce href="/partner-program" center>
        <strong>Want to become a DatoCMS Partner?</strong> Learn more about our Partner Program and its
        benefits!
      </Announce>
    </Space>
  </Wrapper>

  <Wrapper>
    <FetchAndReplaceFormOnSubmit>
      <form class={s.filterGrid} method="GET">
        <div>
          <div class={s.filterLabel}>Filter by Continent</div>
          <Filter
            options={continentOptions}
            value={continentFilter}
            searchParam="continent"
            resetSearchParams={['country']}
          />
        </div>
        <div>
          <div class={s.filterLabel}>Filter by Country</div>
          <Filter options={countryOptions} value={countryFilter} searchParam="country" />
        </div>
        <div>
          <div class={s.filterLabel}>Filter by Technology</div>
          <Filter options={technologyOptions} value={technologyFilter} searchParam="technology" />
        </div>
        <div>
          <div class={s.filterLabel}>Filter by Area of Expertise</div>
          <Filter
            options={areaOfExpertiseOptions}
            value={areaOfExpertiseFilter}
            searchParam="areaOfExpertise"
          />
        </div>
      </form>
      <div class={s.posts} id="filtered-partners">
        {
          filteredPartners
            .map((p) => orderedPartnersWithStega.find((op) => op.id === p.id)!)
            .map((partner, i) => (
              <Card
                href={buildUrlForPartner(partner)}
                background={bkgColors[i % bkgColors.length]}
                label={getLabel(partner._allReferencingShowcaseProjectsMeta.count) || undefined}
                lineClamp={3}
                svgLogo={partner.logo}
                title={partner.name}
              >
                <Fragment slot="title">
                  <span class={s.cardTitle}>{partner.name}</span>
                  {partner.locations.slice(0, 5).map((l) => (
                    <span class={s.cardFlag}>{l.emoji}</span>
                  ))}
                  {partner.locations.length > 5 && (
                    <span class={s.cardMoreLocations}>+ {partner.locations.length - 5} more</span>
                  )}
                </Fragment>
                {toPlainText(partner.shortDescription)}
              </Card>
            ))
        }
      </div>
    </FetchAndReplaceFormOnSubmit>
  </Wrapper>

  <DraftModeQueryListener query={query} />
</Layout>
