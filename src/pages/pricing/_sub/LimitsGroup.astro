---
import { Svg } from '~/components/Svg';
import Tooltip from '~/components/Tooltip/Tooltip.astro';
import s from '../_style.module.css';
import { formatLimit, formatExtra, formatUpperBoundLimitRaw } from './planLimitsHelpers';
import { HintFragment } from '../_graphql';
import type { FragmentOf } from 'gql.tada';
import { type Plan } from './perOwnerPricingPlans';

// If you change one of these arrays, you need to change them on dashboard too!
// .src/utils/websiteLimitsGrouping.ts

const planLimitsAndOverages = [
  'sites', // Projects
  'sandbox_environments', // Sandbox environments
  'users', // Collaborators
  'item_types', // Models
  'locales', // Locales
  'items', // Records
];

const usageBasedLimits = [
  'traffic_bytes', // Bandwidth
  'cda_api_calls', // CDA API Calls
  'cma_api_calls', // CMA API Calls
  'mux_streaming_seconds', // Video streaming
];

const notExtendableLimits = [
  'support_level', // Support
  'uploadable_bytes', // File storage
  'history_retention_days', // History retention
];

const limitGroups = [
  { title: 'Plan limits & overages', limits: planLimitsAndOverages },
  { title: 'Usage-based limits', limits: usageBasedLimits },
  { title: 'Non-extendable limits', limits: notExtendableLimits },
];

type Props = {
  hints: FragmentOf<typeof HintFragment>[];
  freePlan: Plan;
  proPlan: Plan;
};

const { proPlan, hints } = Astro.props;
---

{
  limitGroups.map((group, groupIndex) => {
    let rowCounter = 0;

    return (
      <>
        <tr class={s.fTableGroup} data-header-for-group={`limits-${groupIndex}`} data-open>
          <td colspan={3}>
            <Svg name="icons/regular/chevron-down" class={s.fTableGroupIcon} data-show-if="open" />
            <Svg
              name="icons/regular/chevron-right"
              class={s.fTableGroupIcon}
              data-show-if="closed"
            />
            {group.title}
            <span class={s.fTableGroupCount} data-show-if="closed">
              ({group.limits.length})
            </span>
          </td>
        </tr>
        {group.limits.map((limitId) => {
          const hint = hints.find((h) => h.apiId === limitId)!;
          const proPlanLimit = proPlan.attributes.limits.find((l) => l.id === limitId)!;
          const isOdd = rowCounter % 2 === 0;
          rowCounter++;

          return (
            <tr
              class:list={[s.fTableFeature, isOdd && s.fTableFeatureOdd]}
              data-part-of-group={`limits-${groupIndex}`}
              data-limit-row
              data-open
            >
              <th class={s.fTableFeatureName}>
                <div class={s.fTableFeatureNameSplit}>
                  <div class={s.fTableFeatureNameName}>{hint.name}</div>
                  {hint.description && (
                    <Tooltip
                      class={s.fTableFeatureNameInfo}
                      tooltipClass={s.fTableFeatureNameInfoHint}
                    >
                      <Svg name="icons/regular/info-circle" />
                      <div slot="tooltip">{hint.description}</div>
                    </Tooltip>
                  )}
                </div>
              </th>
              <td class={s.fTableFeaturePlan}>
                {formatLimit(proPlanLimit)}

                {'extra_packet_amount' in proPlanLimit && proPlanLimit.extra_packet_amount && (
                  <div class={s.extra}>
                    {formatExtra(proPlanLimit) +
                      ('max_extra_packets' in proPlanLimit && proPlanLimit.max_extra_packets
                        ? `, up to ${formatUpperBoundLimitRaw(proPlanLimit)}`
                        : '')}
                  </div>
                )}
              </td>

              {rowCounter === 1 && (
                <td
                  class={s.fTableFeaturePlan}
                  rowspan={group.limits.length}
                  data-enterprise-limits-cell
                >
                  Custom
                </td>
              )}
            </tr>
          );
        })}
      </>
    );
  })
}
